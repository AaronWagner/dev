Move major code to library. Add test
